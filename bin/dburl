#!/usr/bin/env ruby

require 'uri'

input = ARGV.first

if !input
  puts "Usage: dburl [DATABASE_URL]"
  exit
end

def invalid!
  puts "Couldn't parse your input. Was it a valid database URL?"
  exit
end

begin
  db = URI.parse ARGV.first
rescue URI::InvalidURIError
  invalid!
else
  invalid! unless db.scheme
end

case db.scheme
when 'postgres'
  cmd = "psql"
  cmd += " -h #{db.host}" if db.host
  cmd += " -p #{db.port}" if db.port
  cmd += " -U #{db.user}" if db.user
  cmd += " -d #{db.path[1..-1]}" if db.path

  cmd = "PGPASSWORD=#{db.password} #{cmd}" if db.password
else
  puts "This script doesn't support #{db.scheme} yet."
  puts "Please add it and open a pull request."
end

puts cmd
Kernel.exec cmd
